<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>清潔人員簽到簽退（v5）</title>
  <style>
    body { font-family: "Noto Sans TC", Arial, sans-serif; padding: 16px; background: #f6f7fb; }
    h1 { font-size: 20px; }
    select, button, input { margin: 6px 0; padding: 10px; font-size: 16px; border-radius: 8px; }
    .btn { background: #e9eefc; border: 1px solid #ccc; margin: 4px; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .status { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .online { background: #d4edda; color: #155724; }
    .offline { background: #fff3cd; color: #856404; }
    .log { background: #fff; border: 1px solid #eee; padding: 10px; margin-top: 10px; font-size: 14px; white-space: pre-line; max-height: 240px; overflow-y: auto; }
    .muted { color:#6b7280; font-size:12px; }
  </style>
</head>
<body>
  <h1>清潔人員簽到簽退 <span id="net" class="status offline">離線</span></h1>

  <label>人員</label><br/>
  <select id="staff">
    <option value="C004">陳雀惠</option>
    <option value="C005">陳清淇</option>
  </select><br/>

  <label>地點（可選）</label><br/>
  <input id="site" type="text" placeholder="如：D區大廳 / 地下室"><br/>

  <div>
    <button class="btn" onclick="mark('AM_IN')">早上簽到</button>
    <button class="btn" onclick="mark('AM_OUT')">早上簽退</button>
    <button class="btn" onclick="mark('PM_IN')">下午簽到</button>
    <button class="btn" onclick="mark('PM_OUT')">下午簽退</button>
    <button class="btn" onclick="mark('OT_IN')">加班簽到</button>
    <button class="btn" onclick="mark('OT_OUT')">加班簽退</button>
  </div>

  <div style="margin-top:8px">
    <button class="btn" onclick="exportCsv()">匯出CSV</button>
    <button class="btn" onclick="syncQueue()">立即同步</button>
  </div>

  <div style="margin-top:8px">
    <label>Webhook URL</label><br/>
    <input id="webhook" type="url" placeholder="https://script.google.com/macros/s/.../exec" style="width:100%">
    <div class="muted">上傳格式 JSON：{ id, staff_id, staff_name, action, ts_iso, ts_local, tz, site, device, uploaded }</div>
  </div>

  <div class="log" id="log"></div>

<script>
/* ===== 基本設定 ===== */
const STAFF = [
  { id: "C004", name: "陳雀惠" },
  { id: "C005", name: "陳清淇" },
];
const STORAGE_KEY = "records_v5";
const QUEUE_KEY   = "queue_v5";
const CONFIG_KEY  = "cfg_v5";

/* ===== 小工具 ===== */
const $ = (s) => document.querySelector(s);

function qs(name) {
  const p = new URLSearchParams(location.search);
  return p.get(name);
}
function nowISO() { return new Date().toISOString(); }
function fmtLocal(ts) {
  return new Date(ts).toLocaleString("zh-TW", { timeZone: "Asia/Taipei", hour12: false });
}
function tzName() {
  try { return Intl.DateTimeFormat().resolvedOptions().timeZone || "Asia/Taipei"; }
  catch { return "Asia/Taipei"; }
}
function deviceId() {
  const k = "dev_id_v5";
  let id = localStorage.getItem(k);
  if (!id) { id = "dev-" + Math.random().toString(36).slice(2,9); localStorage.setItem(k, id); }
  return id;
}
function loadList(k) { try { return JSON.parse(localStorage.getItem(k)) || []; } catch { return []; } }
function saveList(k, v) { localStorage.setItem(k, JSON.stringify(v)); }

function setNet() {
  const el = $("#net");
  if (navigator.onLine) { el.textContent = "在線"; el.className = "status online"; }
  else { el.textContent = "離線"; el.className = "status offline"; }
}

/* ===== 顯示紀錄 ===== */
function render() {
  const list = loadList(STORAGE_KEY);
  $("#log").textContent = list.map(r =>
    `${r.staff_name} - ${r.action} - ${r.ts_local}${r.uploaded ? " ✓" : ""}`
  ).join("\n");
}

/* ===== 匯出 CSV ===== */
function toCSV(rows) {
  const headers = ["id","staff_id","staff_name","action","ts_iso","ts_local","tz","site","device","uploaded","uploaded_at"];
  const esc = (v) => {
    if (v === undefined || v === null) return "";
    const s = String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const lines = [headers.join(",")];
  rows.forEach(r => lines.push(headers.map(h => esc(r[h])).join(",")));
  return lines.join("\n");
}
function exportCsv() {
  const list = loadList(STORAGE_KEY).slice().reverse();
  const csv = toCSV(list);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "attendance.csv"; a.click();
  URL.revokeObjectURL(url);
}

/* ===== 同步到 Webhook ===== */
async function syncQueue() {
  setNet();
  if (!navigator.onLine) return;
  const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || "{}");
  if (!cfg.webhook) return;

  let q = loadList(QUEUE_KEY);
  for (let i = 0; i < q.length; i++) {
    const rec = q[i];
    try {
      const res = await fetch(cfg.webhook, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(rec),
      });
      if (res.ok) {
        rec.uploaded = true;
        rec.uploaded_at = nowISO();
        // 更新本機列表
        const list = loadList(STORAGE_KEY);
        const idx = list.findIndex(x => x.id === rec.id);
        if (idx >= 0) { list[idx] = rec; saveList(STORAGE_KEY, list); }
        // 佇列移除
        q = q.filter(x => x.id !== rec.id);
        saveList(QUEUE_KEY, q);
        render();
      }
    } catch (_) {
      // 連線/伺服器問題 → 下次再試
      break;
    }
  }
}

/* ===== 打卡 ===== */
function mark(action) {
  const staffId = $("#staff").value;
  const staffName = STAFF.find(s => s.id === staffId)?.name || staffId;
  const site = $("#site").value.trim();
  const tsIso = nowISO();

  const rec = {
    id: `${staffId}|${action}|${tsIso}`,
    staff_id: staffId,
    staff_name: staffName,
    action,
    ts_iso: tsIso,
    ts_local: fmtLocal(tsIso),
    tz: tzName(),
    site,
    device: deviceId(),
    uploaded: false,
    uploaded_at: ""
  };

  // 本機列表＋上傳佇列
  const list = loadList(STORAGE_KEY); list.unshift(rec); saveList(STORAGE_KEY, list);
  const queue = loadList(QUEUE_KEY); queue.push(rec); saveList(QUEUE_KEY, queue);

  render(); syncQueue();
  if (navigator.vibrate) navigator.vibrate(20);
}

/* ===== 初始化 ===== */
(function init() {
  setNet();
  window.addEventListener("online", setNet);
  window.addEventListener("offline", setNet);

  // 載入 Webhook 設定
  const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || "{}");
  if (cfg.webhook) $("#webhook").value = cfg.webhook;
  $("#webhook").addEventListener("change", (e) => {
    const c = JSON.parse(localStorage.getItem(CONFIG_KEY) || "{}");
    c.webhook = e.target.value.trim();
    localStorage.setItem(CONFIG_KEY, JSON.stringify(c));
  });

  // 支援網址參數：?staff=、可選 ?act=
  const sid = qs("staff");
  const act = qs("act");
  if (sid) { $("#staff").value = sid; }
  if (sid && act) { mark(act); }

  render();
})();
</script>
</body>
</html>
